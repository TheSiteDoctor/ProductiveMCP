# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

An MCP (Model Context Protocol) server that exposes 50+ tools for interacting with the Productive.io API. It runs over stdio transport and is consumed by Claude Desktop, Claude Code, and other MCP-compatible clients.

## Commands

```bash
npm run build    # TypeScript compilation (tsc) → dist/
npm run dev      # Watch mode with tsx auto-reload
npm start        # Run compiled server (dist/index.js)
npm run setup    # Auto-discover Productive.io custom fields → productive.config.json
npm run clean    # Remove dist/
```

There are no tests or linting configured in this project.

## Architecture

### Entry Point & Server Setup

`src/index.ts` is the monolithic entry point (~2700 lines). It creates an MCP `Server` instance with stdio transport and registers two request handlers:

1. **ListToolsRequestSchema** — returns all tool definitions (name, description, inputSchema)
2. **CallToolRequestSchema** — routes tool calls to handler functions, validates args with Zod, formats responses

### Tool Pattern

Each tool follows this flow:

```
User request → Zod schema validation → tool handler function → ProductiveClient API call → response formatting → Markdown/JSON output
```

Tool implementations live in `src/tools/` (one file per domain). Each exports async functions with signature:

```typescript
async function toolName(
  client: ProductiveClient,
  args: ValidatedArgs,
): Promise<string>;
```

Schemas live in `src/schemas/` (one file per domain, plus `common.ts` for shared validators). All schemas use `.strict()` mode.

### API Client

`src/client.ts` — `ProductiveClient` wraps axios with:

- JSON:API headers (`application/vnd.api+json`)
- Auth via `X-Auth-Token` and `X-Organization-Id`
- Built-in rate limiting (100 requests/10s sliding window via `src/utils/rate-limiter.ts`)
- All logging goes to stderr (to avoid corrupting stdio MCP transport)

### Runtime Configuration

`src/constants.ts` loads `productive.config.json` (generated by `npm run setup`) at startup for org-specific custom field IDs, task type/priority option mappings, and workflow status names. The server works without this file but custom fields won't be available.

### Key Utilities

- `src/utils/formatting.ts` — response formatting (Markdown/JSON), Markdown→HTML conversion (for task descriptions), Markdown→Productive document format (for pages)
- `src/utils/errors.ts` — `ProductiveAPIError` class, HTTP status-specific error messages, env var validation
- `src/types.ts` — JSON:API response types and "Formatted" variants (e.g. `Task` → `FormattedTask` with resolved relationships)

### Body Format Gotchas

Different Productive API endpoints expect different formats for rich text body content:

| Endpoint     | Input accepted   | Sent to API as                                | Function                          |
| ------------ | ---------------- | --------------------------------------------- | --------------------------------- |
| **Tasks**    | Markdown or HTML | HTML string                                   | `markdownToHtml()`                |
| **Comments** | Markdown or HTML | HTML string                                   | `markdownToHtml()`                |
| **Pages**    | Markdown         | Stringified JSON (`"{\"type\":\"doc\",...}"`) | `markdownToProductiveDocString()` |

Pages use Productive's ProseMirror document format. The body attribute must be a **string** containing JSON — not a raw JSON object. The `ProductiveDoc` type in `src/types.ts` defines the structure.

### Response Constraints

All tool responses are capped at 25,000 characters (`CHARACTER_LIMIT` in constants.ts) with pagination hints when truncated.

## Adding a New Tool

1. Create/extend a Zod schema in `src/schemas/`
2. Create/extend a handler function in `src/tools/`
3. Register the tool definition in the `ListToolsRequestSchema` handler in `src/index.ts`
4. Add the routing case in the `CallToolRequestSchema` handler in `src/index.ts`

## Environment

Requires `PRODUCTIVE_API_TOKEN` and `PRODUCTIVE_ORG_ID` environment variables. Copy `.env.example` to `.env` for local development. The setup script reads `.env` directly.

## Versioning

We follow [Semantic Versioning](https://semver.org/). For each release:

1. Add an entry to `CHANGELOG.md` following [Keep a Changelog](https://keepachangelog.com) format
2. Bump the `version` in `package.json`
3. Commit the version bump, then tag with `git tag vX.Y.Z`

## ES Modules

This is an ESM project (`"type": "module"` in package.json). All internal imports must use `.js` extensions (e.g. `import { foo } from "./bar.js"`), even though source files are `.ts`.
